#!/bin/sh
. /lib/functions.sh
. /lib/functions/network.sh
. /lib/mwan3/mwan3.sh

LOG="logger -t $(basename "$0")[$$] -p"

clean_up() {
	$LOG notice "Stopping mwan3rtmon..."
	exit 0
}


main() {
	local IP family
	trap clean_up TERM

	config_load mwan3
	family=$1
	[ -z $family ] && family=ipv4
	if [ "$family" = ipv6 ]; then
		IP="$IP6"
	else
		IP="$IP4"
	fi
	$IP monitor route | while read line; do
		[ -z "${line##*table*}" ] && continue
		$LOG notice "handling route update $family $line"
		network_flush_cache
		mwan3_lock "service" "mwan3rtmon"
		mwan3_rtmon_route_handle "$line" "$family"
		mwan3_unlock "service" "mwan3rtmon"
	done &
	wait 2>/dev/null
}
main "$@"
